#!/bin/sh
# Pre-commit hook: Auto-format Go files before commit

# Check if go is installed
if ! command -v go &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: 'go' command not found. Skipping auto-format."
    echo "   Please install Go from https://go.dev/dl/"
    exit 0
fi

# Get list of staged Go files (excluding generated files)
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' | grep -v '\.pb\.go$' | grep -v 'vendor/')

if [ -z "$STAGED_GO_FILES" ]; then
    # No Go files staged, continue
    exit 0
fi

echo "üîß Auto-formatting staged Go files..."

# Format each staged Go file
NEEDS_RESTAGE=0
for file in $STAGED_GO_FILES; do
    if [ -f "$file" ]; then
        echo "  ‚Üí Formatting: $file"
        
        # Run gofmt on the file
        gofmt -s -w "$file"
        
        # Check if file was modified
        if ! git diff --quiet "$file"; then
            NEEDS_RESTAGE=1
            # Re-stage the formatted file
            git add "$file"
        fi
    fi
done

if [ $NEEDS_RESTAGE -eq 1 ]; then
    echo "‚úÖ Go files auto-formatted and re-staged"
else
    echo "‚úÖ All Go files already formatted correctly"
fi

exit 0

